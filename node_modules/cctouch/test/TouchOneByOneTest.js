var TouchOneByOneTest = cc.Layer.extend({
    _winSize:null,
    init: function () {
        this._super();

        this._winSize = cc.Director.getInstance().getWinSize();
        this.ids = {};
        this.unused_sprites = [];

        if( 'touches' in sys.capabilities ) {
            this.setTouchMode(cc.TOUCH_ONE_BY_ONE);
            this.setTouchEnabled(true);
        } else {
            logTest("TOUCH-ONE-BY-ONE test is not supported on desktop");
        }

        for (var i = 0; i < 5; i++) {
            var sprite = this.sprite = cc.Sprite.create(res.r2_png);
            this.addChild(sprite, i + 10);
            sprite.setPosition(0, 0);
            sprite.setScale(1);
            sprite.setColor(cc.c3b(Math.random() * 200 + 55, Math.random() * 200 + 55, Math.random() * 200 + 55));
            this.unused_sprites.push(sprite);
        }

        return true;
    },
    new_id:function( id, pos) {
        var s = this.unused_sprites.pop();
        this.ids[ id ] = s;
        s.setPosition( pos );
    },
    update_id:function(id, pos) {
        var s = this.ids[ id ];
        s.setPosition( pos );
    },
    release_id:function(id, pos) {
        var s = this.ids[ id ];
        this.ids[ id ] = null;
        this.unused_sprites.push( s );
        s.setPosition(0,0);
    },

    onTouchBegan:function(touch, event) {
        var pos = touch.getLocation();
        var id = touch.getId();
        logTest("onTouchBegan at: " + pos.x + " " + pos.y + " Id:" + id );
        if( pos.x < this._winSize.width/2) {
            this.new_id(id,pos);
            return true;
        }
        return false;
    },
    onTouchMoved:function(touch, event) {
        var pos = touch.getLocation();
        var id = touch.getId();
        logTest("onTouchMoved at: " + pos.x + " " + pos.y + " Id:" + id );
        this.update_id(id,pos);
    },
    onTouchEnded:function(touch, event) {
        var pos = touch.getLocation();
        var id = touch.getId();
        logTest("onTouchEnded at: " + pos.x + " " + pos.y + " Id:" + id );
        this.release_id(id,pos);
    },
    onTouchCancelled:function(touch, event) {
        var pos = touch.getLocation();
        var id = touch.getId();
        logTest("onTouchCancelled at: " + pos.x + " " + pos.y + " Id:" + id );
        this.update_id(id,pos);
    }
});

TouchOneByOneTest.create = function(args){
    var layer = new TouchOneByOneTest();
    return layer.init() ? layer : null;
};
